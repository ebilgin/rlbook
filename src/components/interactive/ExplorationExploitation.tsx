/**
 * Exploration vs Exploitation Interactive Demo
 *
 * A simple slot machine (bandit) demo that lets users experience
 * the exploration-exploitation tradeoff firsthand:
 * - 3 slot machines with hidden true probabilities
 * - User can pull any machine and observe rewards
 * - Tracks estimated values vs true values
 * - Shows regret accumulated from not choosing the best
 *
 * Usage:
 *   <ExplorationExploitation />
 */

import React, { useState, useCallback } from 'react';

interface Machine {
  id: number;
  trueProbability: number; // Hidden from user
  pulls: number;
  wins: number;
}

const INITIAL_MACHINES: Machine[] = [
  { id: 0, trueProbability: 0.3, pulls: 0, wins: 0 },
  { id: 1, trueProbability: 0.5, pulls: 0, wins: 0 },
  { id: 2, trueProbability: 0.7, pulls: 0, wins: 0 },
];

// Shuffle machines so the best one isn't always in the same position
function shuffleArray<T>(array: T[]): T[] {
  const shuffled = [...array];
  for (let i = shuffled.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
  }
  return shuffled;
}

export function ExplorationExploitation() {
  const [machines, setMachines] = useState<Machine[]>(() =>
    shuffleArray(INITIAL_MACHINES.map(m => ({ ...m })))
  );
  const [totalPulls, setTotalPulls] = useState(0);
  const [totalWins, setTotalWins] = useState(0);
  const [lastResult, setLastResult] = useState<{ machineId: number; won: boolean } | null>(null);
  const [showTrueProbabilities, setShowTrueProbabilities] = useState(false);
  const [regret, setRegret] = useState(0);

  const bestProbability = Math.max(...machines.map(m => m.trueProbability));

  const pullMachine = useCallback((machineIndex: number) => {
    const machine = machines[machineIndex];
    const won = Math.random() < machine.trueProbability;

    setMachines(prev => prev.map((m, i) =>
      i === machineIndex
        ? { ...m, pulls: m.pulls + 1, wins: m.wins + (won ? 1 : 0) }
        : m
    ));

    setTotalPulls(prev => prev + 1);
    setTotalWins(prev => prev + (won ? 1 : 0));
    setLastResult({ machineId: machineIndex, won });

    // Regret = opportunity cost of not choosing the best
    const instantRegret = bestProbability - machine.trueProbability;
    setRegret(prev => prev + instantRegret);
  }, [machines, bestProbability]);

  const reset = () => {
    setMachines(shuffleArray(INITIAL_MACHINES.map(m => ({ ...m }))));
    setTotalPulls(0);
    setTotalWins(0);
    setLastResult(null);
    setShowTrueProbabilities(false);
    setRegret(0);
  };

  const getEstimatedValue = (machine: Machine): number | null => {
    if (machine.pulls === 0) return null;
    return machine.wins / machine.pulls;
  };

  const getConfidenceWidth = (machine: Machine): number => {
    // More pulls = more confidence = narrower bar
    if (machine.pulls === 0) return 100;
    return Math.max(10, 100 / Math.sqrt(machine.pulls));
  };

  return (
    <div className="my-8 p-6 bg-slate-800/50 rounded-xl border border-slate-700">
      {/* Header */}
      <div className="text-center mb-6">
        <h3 className="text-xl font-bold text-slate-200 mb-2">The Slot Machine Game</h3>
        <p className="text-slate-400 text-sm">
          Three slot machines, each with a hidden win probability. Which one is best?
        </p>
      </div>

      {/* Machines */}
      <div className="grid grid-cols-3 gap-4 mb-6">
        {machines.map((machine, index) => {
          const estimated = getEstimatedValue(machine);
          const isLastPulled = lastResult?.machineId === index;

          return (
            <div
              key={machine.id}
              className={`p-4 rounded-xl border-2 transition-all duration-300 ${
                isLastPulled
                  ? lastResult?.won
                    ? 'border-emerald-500 bg-emerald-900/20'
                    : 'border-red-500 bg-red-900/20'
                  : 'border-slate-600 bg-slate-900/30'
              }`}
            >
              {/* Machine visual */}
              <div className="text-center mb-3">
                <div className="text-4xl mb-2">ðŸŽ°</div>
                <div className="text-slate-300 font-medium">Machine {index + 1}</div>
              </div>

              {/* Stats */}
              <div className="space-y-2 text-sm mb-4">
                <div className="flex justify-between">
                  <span className="text-slate-500">Pulls:</span>
                  <span className="text-slate-300">{machine.pulls}</span>
                </div>
                <div className="flex justify-between">
                  <span className="text-slate-500">Wins:</span>
                  <span className="text-emerald-400">{machine.wins}</span>
                </div>
                <div className="flex justify-between">
                  <span className="text-slate-500">Est. Value:</span>
                  <span className="text-amber-400">
                    {estimated !== null ? `${(estimated * 100).toFixed(0)}%` : '?'}
                  </span>
                </div>
                {showTrueProbabilities && (
                  <div className="flex justify-between pt-2 border-t border-slate-700">
                    <span className="text-slate-500">True Value:</span>
                    <span className="text-violet-400">
                      {(machine.trueProbability * 100).toFixed(0)}%
                    </span>
                  </div>
                )}
              </div>

              {/* Confidence visualization */}
              <div className="h-2 bg-slate-700 rounded-full overflow-hidden mb-4">
                {estimated !== null && (
                  <div
                    className="h-full bg-amber-500 transition-all duration-300"
                    style={{ width: `${estimated * 100}%` }}
                  />
                )}
              </div>

              {/* Pull button */}
              <button
                onClick={() => pullMachine(index)}
                className="w-full py-2 px-4 rounded-lg bg-blue-600 text-white font-medium hover:bg-blue-500 transition-colors"
              >
                Pull!
              </button>
            </div>
          );
        })}
      </div>

      {/* Last result */}
      <div className="mb-4 min-h-[50px]">
        {lastResult ? (
          <div className={`text-center p-3 rounded-lg ${
            lastResult.won ? 'bg-emerald-900/30 text-emerald-400' : 'bg-red-900/30 text-red-400'
          }`}>
            <span className="text-xl mr-2">{lastResult.won ? 'ðŸŽ‰' : 'ðŸ˜ž'}</span>
            Machine {lastResult.machineId + 1}: {lastResult.won ? 'WIN!' : 'No win'}
          </div>
        ) : (
          <div className="text-center p-3 rounded-lg bg-slate-900/30 text-slate-500">
            Pull a machine to see if you win!
          </div>
        )}
      </div>

      {/* Metrics */}
      <div className="flex justify-center gap-8 mb-6">
        <div className="text-center">
          <div className="text-2xl font-bold text-slate-200">{totalPulls}</div>
          <div className="text-slate-500 text-sm">Total Pulls</div>
        </div>
        <div className="text-center">
          <div className="text-2xl font-bold text-emerald-400">{totalWins}</div>
          <div className="text-slate-500 text-sm">Total Wins</div>
        </div>
        <div className="text-center">
          <div className="text-2xl font-bold text-amber-400">
            {totalPulls > 0 ? `${((totalWins / totalPulls) * 100).toFixed(0)}%` : '-'}
          </div>
          <div className="text-slate-500 text-sm">Win Rate</div>
        </div>
        {showTrueProbabilities && (
          <div className="text-center">
            <div className="text-2xl font-bold text-red-400">
              {regret.toFixed(1)}
            </div>
            <div className="text-slate-500 text-sm">Regret</div>
          </div>
        )}
      </div>

      {/* Controls */}
      <div className="flex justify-center gap-3 flex-wrap">
        <button
          onClick={reset}
          className="px-4 py-2 rounded-lg bg-slate-600 text-white font-medium hover:bg-slate-500 transition-colors"
        >
          Reset
        </button>
        <button
          onClick={() => setShowTrueProbabilities(!showTrueProbabilities)}
          className={`px-4 py-2 rounded-lg font-medium transition-colors ${
            showTrueProbabilities
              ? 'bg-violet-600 text-white hover:bg-violet-500'
              : 'bg-slate-600 text-white hover:bg-slate-500'
          }`}
        >
          {showTrueProbabilities ? 'Hide True Values' : 'Reveal True Values'}
        </button>
      </div>

      {/* Educational callout */}
      <div className="mt-6 p-4 bg-slate-900/30 rounded-lg">
        <div className="text-slate-400 text-sm">
          <strong className="text-slate-300">The Dilemma:</strong> Should you keep pulling the machine that seems best so far (exploit), or try others to discover if they're actually better (explore)? If you only exploit, you might miss the truly best option. If you only explore, you waste pulls on bad machines.
          {showTrueProbabilities && (
            <div className="mt-2 text-violet-300">
              <strong>Regret</strong> measures how much reward you've lost by not always choosing the best machine. Lower is better!
            </div>
          )}
        </div>
      </div>
    </div>
  );
}

export default ExplorationExploitation;
