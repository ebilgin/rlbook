---
import ChapterLayout from '../../layouts/ChapterLayout.astro';
import { chapters, type ChapterData } from '../../lib/chapters';

export function getStaticPaths() {
  return Object.keys(chapters).map((slug) => ({
    params: { slug },
    props: { chapterData: chapters[slug] },
  }));
}

interface Props {
  chapterData: ChapterData;
}

const { chapterData } = Astro.props;

// Try to import the MDX content for this chapter
let Content = null;
let frontmatter = null;
let hasContent = false;

try {
  // Dynamic import of MDX file based on chapter directory
  const mdxModules = import.meta.glob('/content/chapters/*/index.mdx', { eager: true });
  const mdxPath = `/content/chapters/${chapterData.dirName}/index.mdx`;

  if (mdxModules[mdxPath]) {
    const mdxModule = mdxModules[mdxPath] as any;
    Content = mdxModule.default;
    frontmatter = mdxModule.frontmatter || {};
    hasContent = true;
  }
} catch (e) {
  // Content not found, will show placeholder
  console.log(`No content found for ${chapterData.slug}`);
}

// Merge frontmatter with chapter data
const mergedFrontmatter = {
  title: frontmatter?.title || chapterData.title,
  section: frontmatter?.section || chapterData.section,
  description: frontmatter?.description || chapterData.description,
  status: frontmatter?.status || chapterData.status,
  lastReviewed: frontmatter?.lastReviewed,
  prerequisites: frontmatter?.prerequisites,
  chapter: parseInt(chapterData.dirName.split('-')[0]) / 10, // Convert 1010 -> 101, 2010 -> 201
};
---

<ChapterLayout frontmatter={mergedFrontmatter}>
  {hasContent && Content ? (
    <Content />
  ) : (
    <div class="text-center py-20 bg-gray-50 rounded-xl">
      <div class="text-6xl mb-4">ğŸš§</div>
      <h2 class="text-2xl font-bold mb-4">Content Coming Soon</h2>
      <p class="text-gray-600 max-w-md mx-auto mb-6">
        This chapter is currently being generated from our prompt templates.
        Check back soon or contribute on GitHub!
      </p>
      <div class="flex justify-center gap-4">
        <a
          href={`https://github.com/ebilgin/rlbook/blob/main/content/chapters/${chapterData.dirName}/prompt.md`}
          class="text-primary-600 hover:underline"
          target="_blank"
        >
          View Prompt â†’
        </a>
        <a href="/" class="text-gray-600 hover:underline">
          â† Back to Home
        </a>
      </div>
    </div>
  )}
</ChapterLayout>
